<?php
/**
 * Image.
 *
 * @copyright Michael Ueberschaer (MU)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Michael Ueberschaer <kontakt@webdesign-in-bremen.com>.
 * @link http://www.webdesign-in-bremen.com
 * @link http://zikula.org
 * @version Generated by ModuleStudio (http://modulestudio.de).
 */

namespace MU\ImageModule\Helper;

use MU\ImageModule\Helper\Base\AbstractViewHelper;

use Symfony\Bundle\TwigBundle\Loader\FilesystemLoader;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\RequestStack;
use Symfony\Component\HttpFoundation\Response;
use Twig_Environment;
use Zikula\Core\Response\PlainResponse;
use Zikula\ExtensionsModule\Api\ApiInterface\VariableApiInterface;
use Zikula\ThemeModule\Engine\ParameterBag;
use MU\ImageModule\Helper\ControllerHelper;
use MU\ImageModule\Helper\PermissionHelper;
use Symfony\Component\HttpFoundation\Session\SessionInterface;


/**
 * Helper implementation class for view layer methods.
 */
class ViewHelper extends AbstractViewHelper
{
    /**
     * @var SessionInterface
     */
    protected $session;
    
    /**
     * ViewHelper constructor.
     *
     * @param Twig_Environment
     * @param FilesystemLoader     $twigLoader       Twig loader service instance
     * @param RequestStack         $requestStack     RequestStack service instance
     * @param VariableApiInterface $variableApi      VariableApi service instance
     * @param ParameterBag         $pageVars         ParameterBag for theme page variables
     * @param ControllerHelper     $controllerHelper ControllerHelper service instance
     * @param PermissionHelper     $permissionHelper PermissionHelper service instance
     * @param SessionInterface     $session          SessionInterface service instance 
     *
     * @return void
     */
    public function __construct(
    		Twig_Environment $twig,
    		FilesystemLoader $twigLoader,
    		RequestStack $requestStack,
    		VariableApiInterface $variableApi,
    		ParameterBag $pageVars,
    		ControllerHelper $controllerHelper,
    		PermissionHelper $permissionHelper,
    		SessionInterface $session
    		) {
    			$this->twig = $twig;
    			$this->twigLoader = $twigLoader;
    			$this->request = $requestStack->getCurrentRequest();
    			$this->variableApi = $variableApi;
    			$this->pageVars = $pageVars;
    			$this->controllerHelper = $controllerHelper;
    			$this->permissionHelper = $permissionHelper;
    			$this->session = $session;
    }
	
    /**
     * Helper method for managing view templates.
     *
     * @param string  $type               Current controller (name of currently treated entity)
     * @param string  $func               Current function (index, view, ...)
     * @param array   $templateParameters Template data
     * @param string  $template           Optional assignment of precalculated template file
     *
     * @return mixed Output
     */
    public function processTemplate($type, $func, array $templateParameters = [], $template = '')
    {
        $templateExtension = $this->determineExtension($type, $func);
        if (empty($template)) {
            $template = $this->getViewTemplate($type, $func);
        }
        
        // special template parameters for album display
        if ($type == 'album' && $func == 'display') {
        	$slideshow = $this->variableApi->get('MUImageModule', 'slideshow1');
        	    $templateParameters['slideshow1'] = $slideshow;
        	    $useTemplate = $this->session->get('useTemplate', '');
        	    //$useTemplate = \SessionUtil::getVar('useTemplate', '');
        	    if ($useTemplate == '') {
        		    $templateParameters['useTemplate'] = '1';
        	    } else {
        		    $templateParameters['useTemplate'] = $useTemplate;
        	    }
        }
    
        if ($templateExtension == 'pdf.twig') {
            $template = str_replace('.pdf', '.html', $template);
    
            return $this->processPdf($templateParameters, $template);
        }
    
        // look whether we need output with or without the theme
        $raw = $this->request->query->getBoolean('raw', false);
        if (!$raw && $templateExtension != 'html.twig') {
            $raw = true;
        }
    
        $output = $this->twig->render($template, $templateParameters);
        $response = null;
        if (true === $raw) {
            // standalone output
            $response = new PlainResponse($output);
        } else {
            // normal output
            $response = new Response($output);
        }
    
        // check if we need to set any custom headers
        switch ($templateExtension) {
            case 'rss.twig':
                $response->headers->set('Content-Type', 'application/rss+xml');
                break;
        }
    
        return $response;
    }
    
    public function template($args)
    {
    	$request = new Zikula_Request_Http();
    	$template = $args['template'];
    	SessionUtil::setVar('template', $template);
    }
}
